{% comment %}
  Ingredient Science Hub v2
  - Image/name at TOP of card
  - Black, white, gold (#D4AF37) color scheme
  - Mobile: Horizontal carousel with peek effect
  - Desktop: Grid layout
{% endcomment %}

<section
  class="ingredient-hub"
  id="ingredient-hub-{{ section.id }}"
  data-section-id="{{ section.id }}"
  data-card-count="{{ section.blocks.size }}"
>
  <div class="ingredient-hub__container">
    {% if section.settings.title != blank %}
      <h2 class="ingredient-hub__title">{{ section.settings.title }}</h2>
    {% endif %}

    {% if section.settings.subtitle != blank %}
      <p class="ingredient-hub__subtitle">{{ section.settings.subtitle }}</p>
    {% endif %}

    {% if section.blocks.size > 0 %}
      <div class="ingredient-hub__carousel">
        {% for block in section.blocks %}
          {% case block.type %}
            {% when 'ingredient' %}
              <article
                class="ingredient-card"
                data-block-id="{{ block.id }}"
                data-index="{{ forloop.index0 }}"
                {{ block.shopify_attributes }}
              >
                {%- comment -%} Ingredient Header (Image & Info) - NOW AT TOP {%- endcomment -%}
                <div class="ingredient-card__header">
                  {% if block.settings.image != blank %}
                    <div class="ingredient-card__image-wrapper">
                      <img
                        src="{{ block.settings.image | image_url: width: 400 }}"
                        srcset="
                          {{ block.settings.image | image_url: width: 200 }} 200w,
                          {{ block.settings.image | image_url: width: 300 }} 300w,
                          {{ block.settings.image | image_url: width: 400 }} 400w
                        "
                        sizes="(max-width: 768px) 120px, 140px"
                        alt="{{ block.settings.name | escape }}"
                        class="ingredient-card__image"
                        loading="lazy"
                        width="140"
                        height="140"
                      >
                    </div>
                  {% endif %}

                  <div class="ingredient-card__info">
                    <h3 class="ingredient-card__name">{{ block.settings.name }}</h3>
                    {% if block.settings.tagline != blank %}
                      <p class="ingredient-card__tagline">{{ block.settings.tagline }}</p>
                    {% endif %}
                  </div>
                </div>

                {%- comment -%} Tab Navigation {%- endcomment -%}
                <nav class="ingredient-card__tabs" role="tablist">
                  <button
                    class="ingredient-card__tab is-active"
                    role="tab"
                    aria-selected="true"
                    id="tab-benefits-{{ block.id }}"
                    aria-controls="panel-benefits-{{ block.id }}"
                    data-tab="benefits"
                    data-card="{{ block.id }}"
                  >
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                      <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                    </svg>
                    <span>Faydalar</span>
                  </button>
                  <button
                    class="ingredient-card__tab"
                    role="tab"
                    aria-selected="false"
                    id="tab-articles-{{ block.id }}"
                    aria-controls="panel-articles-{{ block.id }}"
                    data-tab="articles"
                    data-card="{{ block.id }}"
                  >
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                      <polyline points="14,2 14,8 20,8"/>
                      <line x1="16" y1="13" x2="8" y2="13"/>
                      <line x1="16" y1="17" x2="8" y2="17"/>
                    </svg>
                    <span>Makaleler</span>
                  </button>
                  <button
                    class="ingredient-card__tab"
                    role="tab"
                    aria-selected="false"
                    id="tab-tests-{{ block.id }}"
                    aria-controls="panel-tests-{{ block.id }}"
                    data-tab="tests"
                    data-card="{{ block.id }}"
                  >
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                      <path d="M9 12l2 2 4-4"/>
                      <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/>
                    </svg>
                    <span>Test Sonuçları</span>
                  </button>
                </nav>

                {%- comment -%} Tab Content Area {%- endcomment -%}
                <div class="ingredient-card__content">
                  {%- comment -%} Benefits Tab {%- endcomment -%}
                  <div
                    class="tab-panel is-active"
                    role="tabpanel"
                    id="panel-benefits-{{ block.id }}"
                    aria-labelledby="tab-benefits-{{ block.id }}"
                    data-panel="benefits"
                    data-card="{{ block.id }}"
                    tabindex="0"
                  >
                    <div class="benefits-list">
                      {% assign benefits = block.settings.benefits | newline_to_br | split: '<br />' %}
                      {% for benefit in benefits %}
                        {% assign benefit_text = benefit | strip %}
                        {% if benefit_text != blank %}
                          <div class="benefit-item" style="animation-delay: {{ forloop.index | times: 0.1 }}s">
                            <div class="benefit-item__icon">
                              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22 4 12 14.01 9 11.01"/>
                              </svg>
                            </div>
                            <span class="benefit-item__text">{{ benefit_text }}</span>
                          </div>
                        {% endif %}
                      {% endfor %}
                    </div>
                  </div>

                  {%- comment -%} Articles Tab {%- endcomment -%}
                  <div
                    class="tab-panel"
                    role="tabpanel"
                    id="panel-articles-{{ block.id }}"
                    aria-labelledby="tab-articles-{{ block.id }}"
                    data-panel="articles"
                    data-card="{{ block.id }}"
                    tabindex="0"
                  >
                    <div class="articles-list">
                      {% assign articles = block.settings.articles | newline_to_br | split: '<br />' %}
                      {% for article in articles %}
                        {% assign article_text = article | strip %}
                        {% if article_text != blank %}
                          {% assign article_parts = article_text | split: '|' %}
                          {% assign article_title = article_parts[0] | strip %}
                          {% assign article_source = article_parts[1] | strip %}
                          {% assign article_url = article_parts[2] | strip %}
                          <a
                            href="{{ article_url }}"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="article-card"
                            style="animation-delay: {{ forloop.index | times: 0.15 }}s"
                          >
                            <div class="article-card__icon">
                              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                              </svg>
                            </div>
                            <div class="article-card__content">
                              <h4 class="article-card__title">{{ article_title }}</h4>
                              {% if article_source != blank %}
                                <span class="article-card__source">{{ article_source }}</span>
                              {% endif %}
                            </div>
                            <div class="article-card__arrow">
                              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                                <polyline points="15 3 21 3 21 9"/>
                                <line x1="10" y1="14" x2="21" y2="3"/>
                              </svg>
                            </div>
                            <span class="visually-hidden">(yeni sekmede açılır)</span>
                          </a>
                        {% endif %}
                      {% endfor %}
                      {% if articles.size == 0 or block.settings.articles == blank %}
                        <p class="empty-state">Henüz makale eklenmedi.</p>
                      {% endif %}
                    </div>
                  </div>

                  {%- comment -%} Test Results Tab {%- endcomment -%}
                  <div
                    class="tab-panel"
                    role="tabpanel"
                    id="panel-tests-{{ block.id }}"
                    aria-labelledby="tab-tests-{{ block.id }}"
                    data-panel="tests"
                    data-card="{{ block.id }}"
                    tabindex="0"
                  >
                    <div class="test-results">
                      <div class="test-cards-grid">
                        {% assign tests = block.settings.test_results | newline_to_br | split: '<br />' %}
                        {% for test in tests %}
                          {% assign test_text = test | strip %}
                          {% if test_text != blank %}
                            {% assign test_parts = test_text | split: '|' %}
                            {% assign test_name = test_parts[0] | strip %}
                            {% assign test_result = test_parts[1] | strip %}
                            {% assign test_percent = test_parts[2] | strip | default: '100' %}

                            {% assign test_range = test_parts[3] | strip %}

                            <div class="test-card" style="animation-delay: {{ forloop.index | times: 0.15 }}s">
                              <div class="test-card__header">
                                <div class="test-card__indicator"></div>
                                <h5 class="test-card__name">{{ test_name }}</h5>
                              </div>

                              <div class="test-card__status">
                                {% if test_result == 'GEÇTİ' or test_result == 'PASS' %}
                                  <svg class="test-card__check" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                    <polyline points="22 4 12 14.01 9 11.01"/>
                                  </svg>
                                  <div class="test-card__result-group">
                                    <span class="test-card__result test-card__result--pass">GEÇTİ</span>
                                    {% if test_range != blank %}
                                      <span class="test-card__range">({{ test_range }})</span>
                                    {% endif %}
                                  </div>
                                {% else %}
                                  <span class="test-card__result">{{ test_result }}</span>
                                  {% if test_range != blank %}
                                    <span class="test-card__range">({{ test_range }})</span>
                                  {% endif %}
                                {% endif %}
                              </div>

                              <div class="test-card__progress">
                                <div class="test-card__progress-bar" style="--progress: {{ test_percent }}%"></div>
                              </div>

                              <div class="test-card__percent">%{{ test_percent }}</div>
                            </div>
                          {% endif %}
                        {% endfor %}
                      </div>

                      {%- comment -%} Certification Footer {%- endcomment -%}
                      <div class="test-results__footer">
                        {% if block.settings.certification != blank %}
                          <div class="certification-badge">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                              <circle cx="12" cy="8" r="7"/>
                              <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>
                            </svg>
                            <span>{{ block.settings.certification }}</span>
                          </div>
                        {% endif %}

                        {% if block.settings.test_date != blank %}
                          <div class="test-date">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                              <line x1="16" y1="2" x2="16" y2="6"/>
                              <line x1="8" y1="2" x2="8" y2="6"/>
                              <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                            <span>{{ block.settings.test_date }}</span>
                          </div>
                        {% endif %}
                      </div>

                      {%- comment -%} Contact Note {%- endcomment -%}
                      <div class="test-results__note">
                        <span>*</span> Detaylı analiz raporları için <strong class="test-results__email">info@cyrasoul.com</strong> adresine mail atabilirsiniz.
                      </div>
                    </div>
                  </div>
                </div>
              </article>
          {% endcase %}
        {% endfor %}
      </div>

      {%- comment -%} Carousel Navigation (Mobile Only) {%- endcomment -%}
      {% if section.blocks.size > 1 %}
        <div class="carousel-nav">
          <span class="carousel-counter">
            <span class="carousel-counter__current">1</span>
            <span class="carousel-counter__sep">/</span>
            <span class="carousel-counter__total">{{ section.blocks.size }}</span>
          </span>
          <div class="carousel-dots" aria-label="Carousel navigation">
            {% for block in section.blocks %}
              <button
                class="carousel-dot {% if forloop.first %}is-active{% endif %}"
                data-index="{{ forloop.index0 }}"
                aria-label="İçerik {{ forloop.index }} / {{ section.blocks.size }}"
              ></button>
            {% endfor %}
          </div>
          <span class="carousel-hint">Kaydır →</span>
        </div>
      {% endif %}
    {% else %}
      <div class="ingredient-hub__empty">
        <p>İçerik düzenleyiciden içerik ekleyin.</p>
      </div>
    {% endif %}
  </div>
</section>

<style>
  /* ============================================
     INGREDIENT SCIENCE HUB v2 - GOLD/BLACK/WHITE
     ============================================ */

  #ingredient-hub-{{ section.id }} {
    /* Gold - Only for highlights */
    --hub-gold: #D4AF37;
    --hub-gold-light: rgba(212, 175, 55, 0.08);

    /* Black & White - Primary palette */
    --hub-black: #000000;
    --hub-white: #FFFFFF;
    --hub-gray: #333333;
    --hub-gray-light: rgba(0, 0, 0, 0.04);
    --hub-gray-medium: rgba(0, 0, 0, 0.08);
    --hub-text: #000000;
    --hub-text-muted: rgba(0, 0, 0, 0.56); /* 4.5:1 contrast ratio */
    --hub-bg: {{ section.settings.background_color }};
    --hub-card-bg: #FFFFFF;
    --hub-border: rgba(0, 0, 0, 0.1);
    --hub-surface: #F8F8F8;
    --hub-surface-hover: #F0F0F0;
    --hub-surface-subtle: #FAFAFA;
    --hub-success: #16A34A;
    --hub-success-light: rgba(22, 163, 74, 0.1);

    /* Standardized Typography */
    --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;

    padding: {{ section.settings.padding_top }}px 0 {{ section.settings.padding_bottom }}px;
    background: var(--hub-bg);
    font-family: var(--font-family);
  }

  .ingredient-hub__container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  .ingredient-hub__title {
    font-family: var(--font-family);
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    font-weight: 700;
    text-align: center;
    text-wrap: balance;
    margin-bottom: 0.5rem;
    color: var(--hub-text);
  }

  .ingredient-hub__subtitle {
    font-family: var(--font-family);
    display: inline-block;
    margin: 0 auto 2.5rem;
    padding: 0.5rem 1rem;
    background: var(--hub-success-light);
    color: var(--hub-success);
    font-size: 0.875rem;
    font-weight: 600;
    border-radius: 2rem;
    border: 1px solid var(--hub-success);
  }

  .ingredient-hub__title + .ingredient-hub__subtitle {
    display: block;
    width: fit-content;
  }

  /* ============================================
     CAROUSEL CONTAINER
     ============================================ */

  .ingredient-hub__carousel {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 2rem;
  }

  /* Mobile: Horizontal Infinite Carousel */
  @media (max-width: 767px) {
    .ingredient-hub__container {
      padding: 0;
    }

    .ingredient-hub__title,
    .ingredient-hub__subtitle {
      padding: 0 1rem;
    }

    .ingredient-hub__carousel {
      display: flex;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      gap: 12px;
      /* More peek: show ~40px of adjacent cards */
      padding-left: calc(50vw - 130px);
      padding-right: calc(50vw - 130px);
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
      touch-action: pan-x pinch-zoom;
    }

    .ingredient-hub__carousel::-webkit-scrollbar {
      display: none;
    }

    .ingredient-card {
      flex: 0 0 260px; /* Narrower for more peek visibility */
      scroll-snap-align: center;
      scroll-snap-stop: always;
    }

    /* Clone cards for infinite loop effect */
    .ingredient-card.is-clone {
      pointer-events: none;
    }
  }

  /* ============================================
     INGREDIENT CARD
     ============================================ */

  .ingredient-card {
    background: var(--hub-card-bg);
    border-radius: 1.25rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid var(--hub-border);
    overflow: hidden;
    transition: transform 0.25s ease-out, box-shadow 0.25s ease-out;
  }

  @media (min-width: 768px) {
    .ingredient-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
    }
  }

  /* ============================================
     CARD HEADER (Image & Info) - NOW AT TOP
     ============================================ */

  .ingredient-card__header {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1.5rem 1.5rem 1rem;
    text-align: center;
    background: linear-gradient(180deg, var(--hub-surface-subtle) 0%, var(--hub-white) 100%);
    border-bottom: 1px solid var(--hub-border);
  }

  .ingredient-card__image-wrapper {
    width: 100px;
    height: 100px;
    margin-bottom: 0.75rem;
    border-radius: 50%;
    overflow: hidden;
    background: var(--hub-white);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    border: 2px solid var(--hub-gray-medium);
  }

  .ingredient-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.25s ease-out;
  }

  .ingredient-card:hover .ingredient-card__image {
    transform: scale(1.05);
  }

  .ingredient-card__info {
    text-align: center;
  }

  .ingredient-card__name {
    font-family: var(--font-family);
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--hub-text);
    margin: 0 0 0.25rem 0;
  }

  .ingredient-card__tagline {
    font-family: var(--font-family);
    font-size: 0.9rem;
    color: var(--hub-text);
    margin: 0;
    font-weight: 600;
  }

  /* ============================================
     TAB NAVIGATION
     ============================================ */

  .ingredient-card__tabs {
    display: flex;
    border-bottom: 1px solid var(--hub-border);
    background: var(--hub-white);
    touch-action: manipulation;
  }

  .ingredient-card__tab {
    font-family: var(--font-family);
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.4rem;
    padding: 0.875rem 0.5rem;
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--hub-text-muted);
    background: transparent;
    border: none;
    cursor: pointer;
    transition: color 0.15s ease-out, background-color 0.15s ease-out;
    position: relative;
    -webkit-tap-highlight-color: transparent;
  }

  .ingredient-card__tab svg {
    flex-shrink: 0;
    width: 14px;
    height: 14px;
  }

  .ingredient-card__tab:hover {
    color: var(--hub-text);
    background: var(--hub-gray-light);
  }

  .ingredient-card__tab.is-active {
    color: var(--hub-black);
    font-weight: 600;
  }

  .ingredient-card__tab.is-active::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 15%;
    right: 15%;
    height: 2px;
    background: var(--hub-gold);
    border-radius: 2px 2px 0 0;
  }

  .ingredient-card__tab:focus-visible {
    outline: 2px solid var(--hub-gold);
    outline-offset: -2px;
    border-radius: 2px;
  }

  /* ============================================
     TAB CONTENT - Dynamic height based on content
     ============================================ */

  .ingredient-card__content {
    padding: 1rem;
  }

  .tab-panel {
    display: none;
    animation: fadeIn 0.25s ease-out;
  }

  .tab-panel.is-active {
    display: block;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* ============================================
     BENEFITS TAB
     ============================================ */

  .benefits-list {
    display: flex;
    flex-direction: column;
    gap: 0.625rem;
  }

  .benefit-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.625rem 0.875rem;
    background: var(--hub-white);
    border-radius: 0.5rem;
    border: 1px solid var(--hub-border);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    opacity: 0;
    animation: slideInBenefit 0.25s ease-out forwards;
  }

  @keyframes slideInBenefit {
    from { opacity: 0; transform: translateX(-10px); }
    to { opacity: 1; transform: translateX(0); }
  }

  .benefit-item__icon {
    flex-shrink: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--hub-success-light);
    border-radius: 50%;
    color: var(--hub-success);
  }

  .benefit-item__icon svg {
    width: 14px;
    height: 14px;
  }

  .benefit-item__text {
    font-family: var(--font-family);
    font-size: 0.9rem;
    color: var(--hub-text);
    font-weight: 500;
  }

  /* ============================================
     ARTICLES TAB
     ============================================ */

  .articles-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .article-card {
    display: flex;
    align-items: center;
    gap: 0.875rem;
    padding: 0.875rem;
    background: var(--hub-surface);
    border-radius: 0.625rem;
    text-decoration: none;
    color: inherit;
    transition: background-color 0.15s ease-out, transform 0.15s ease-out;
    opacity: 0;
    animation: slideUpArticle 0.25s ease-out forwards;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }

  .article-card:focus-visible {
    outline: 2px solid var(--hub-gold);
    outline-offset: 2px;
  }

  @keyframes slideUpArticle {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .article-card:hover {
    background: var(--hub-surface-hover);
    transform: translateY(-2px);
  }

  .article-card__icon {
    flex-shrink: 0;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--hub-gray-light);
    border-radius: 0.5rem;
    color: var(--hub-black);
  }

  .article-card__content {
    flex: 1;
    min-width: 0;
  }

  .article-card__title {
    font-family: var(--font-family);
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--hub-text);
    margin: 0 0 0.2rem 0;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .article-card__source {
    font-family: var(--font-family);
    font-size: 0.7rem;
    color: var(--hub-text-muted);
    font-weight: 400;
  }

  .article-card__arrow {
    flex-shrink: 0;
    color: var(--hub-text-muted);
    transition: transform 0.15s ease-out, color 0.15s ease-out;
  }

  .article-card:hover .article-card__arrow {
    transform: translate(2px, -2px);
    color: var(--hub-black);
  }

  .empty-state {
    font-family: var(--font-family);
    text-align: center;
    color: var(--hub-text-muted);
    padding: 2rem;
    font-style: italic;
    font-weight: 400;
  }

  /* ============================================
     TEST RESULTS TAB
     ============================================ */

  .test-results {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .test-cards-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
  }

  @media (max-width: 400px) {
    .test-cards-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Premium Test Card */
  .test-card {
    background: var(--hub-white);
    border: 1px solid var(--hub-border);
    border-radius: 0.875rem;
    padding: 0.875rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    opacity: 0;
    animation: popInCard 0.25s ease-out forwards;
    transition: box-shadow 0.25s ease-out;
  }

  /* Stagger animation for test cards */
  .test-card:nth-child(1) { animation-delay: 0.1s; }
  .test-card:nth-child(2) { animation-delay: 0.2s; }
  .test-card:nth-child(3) { animation-delay: 0.3s; }
  .test-card:nth-child(4) { animation-delay: 0.4s; }
  .test-card:nth-child(5) { animation-delay: 0.5s; }
  .test-card:nth-child(6) { animation-delay: 0.6s; }

  @keyframes popInCard {
    0% { opacity: 0; transform: scale(0.95); }
    100% { opacity: 1; transform: scale(1); }
  }

  /* Subtle hover - informational cards, not interactive */
  @media (hover: hover) {
    .test-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
    }
  }

  .test-card__header {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    margin-bottom: 0.5rem;
    text-align: center;
  }

  .test-card__indicator {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--hub-gold);
  }

  .test-card__name {
    font-family: var(--font-family);
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: var(--hub-text);
    margin: 0;
    text-align: center;
  }

  .test-card__status {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.4rem;
    margin-bottom: 0.625rem;
  }

  .test-card__check {
    color: var(--hub-success);
    animation: checkPop 0.4s ease-out forwards;
  }

  @keyframes checkPop {
    0% { transform: scale(0); opacity: 0; }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); opacity: 1; }
  }

  .test-card__result {
    font-family: var(--font-family);
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--hub-text);
  }

  .test-card__result--pass {
    color: var(--hub-text);
  }

  /* Result group (GEÇTİ + range together) */
  .test-card__result-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.15rem;
  }

  /* Accepted Range - shown inline with result */
  .test-card__range {
    font-family: var(--font-family);
    font-size: 0.65rem;
    color: var(--hub-text-muted);
    font-weight: 500;
  }

  /* Animated Progress Bar */
  .test-card__progress {
    height: 4px;
    background: rgba(0, 0, 0, 0.08);
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 0.4rem;
  }

  .test-card__progress-bar {
    height: 100%;
    width: var(--progress, 100%);
    background: linear-gradient(90deg, var(--hub-black) 0%, var(--hub-gold) 100%);
    border-radius: 2px;
    transform: scaleX(0);
    transform-origin: left;
    animation: fillProgress 0.5s ease-out forwards;
    animation-delay: 0.3s;
  }

  @keyframes fillProgress {
    to { transform: scaleX(1); }
  }

  .test-card__percent {
    font-family: var(--font-family);
    text-align: center;
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--hub-text-muted);
    font-variant-numeric: tabular-nums;
  }

  /* Certification Footer */
  .test-results__footer {
    display: flex;
    justify-content: center;
    gap: 1.25rem;
    flex-wrap: wrap;
    padding-top: 0.5rem;
    border-top: 1px solid var(--hub-border);
  }

  .certification-badge,
  .test-date {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-family: var(--font-family);
    font-size: 0.75rem;
    color: var(--hub-text-muted);
    font-weight: 400;
  }

  .certification-badge svg {
    color: var(--hub-black);
  }

  .certification-badge span {
    font-weight: 600;
    color: var(--hub-black);
  }

  /* Contact Note */
  .test-results__note {
    font-family: var(--font-family);
    font-size: 0.7rem;
    color: var(--hub-text-muted);
    text-align: center;
    padding: 0.625rem;
    background: var(--hub-surface);
    border-radius: 0.5rem;
    font-weight: 400;
  }

  .test-results__note span {
    color: var(--hub-black);
  }

  .test-results__note strong {
    color: var(--hub-text);
    font-weight: 600;
  }

  .test-results__email {
    white-space: nowrap;
  }

  /* ============================================
     CAROUSEL NAVIGATION
     ============================================ */

  .carousel-nav {
    display: none;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    padding: 1rem 1rem 0.5rem;
  }

  @media (max-width: 767px) {
    .carousel-nav {
      display: flex;
    }
  }

  .carousel-counter {
    font-family: var(--font-family);
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--hub-text);
    font-variant-numeric: tabular-nums;
  }

  .carousel-counter__sep {
    color: var(--hub-text-muted);
    margin: 0 0.125rem;
  }

  .carousel-hint {
    font-family: var(--font-family);
    font-size: 0.75rem;
    color: var(--hub-text-muted);
    animation: hintPulse 2s ease-in-out 3;
  }

  @keyframes hintPulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
  }

  .carousel-dots {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
  }

  .carousel-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    border: none;
    background: var(--hub-gray-medium);
    cursor: pointer;
    transition: background-color 0.25s ease-out, transform 0.25s ease-out, border-radius 0.25s ease-out;
    padding: 0;
    position: relative;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }

  /* Expand touch target to 44x44px using pseudo-element */
  .carousel-dot::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 44px;
    height: 44px;
    border-radius: 50%;
  }

  .carousel-dot:hover {
    background: rgba(0, 0, 0, 0.2);
  }

  .carousel-dot:focus-visible {
    outline: 2px solid var(--hub-gold);
    outline-offset: 4px;
  }

  .carousel-dot.is-active {
    background: var(--hub-black);
    transform: scaleX(3);
    border-radius: 4px;
  }

  /* Empty State */
  .ingredient-hub__empty {
    font-family: var(--font-family);
    text-align: center;
    padding: 4rem 2rem;
    color: var(--hub-text-muted);
    font-weight: 400;
  }

  /* Visually Hidden (Screen Reader Only) */
  .visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* ============================================
     REDUCED MOTION SUPPORT
     ============================================ */
  @media (prefers-reduced-motion: reduce) {
    .tab-panel,
    .benefit-item,
    .article-card,
    .test-card,
    .test-card__check,
    .test-card__progress-bar {
      animation: none !important;
      transition-duration: 0.01ms !important;
    }

    .benefit-item,
    .article-card,
    .test-card {
      opacity: 1 !important;
      transform: none !important;
    }

    .test-card__progress-bar {
      transform: scaleX(1) !important;
    }
  }
</style>

<script>
(function() {
  const section = document.getElementById('ingredient-hub-{{ section.id }}');
  if (!section) return;

  // Tab Switching Logic
  const tabs = section.querySelectorAll('.ingredient-card__tab');

  function activateTab(tab) {
    const cardId = tab.dataset.card;
    const tabName = tab.dataset.tab;

    // Update tabs for this card (and its clones)
    section.querySelectorAll(`.ingredient-card__tab[data-card="${cardId}"]`).forEach(t => {
      t.classList.remove('is-active');
      t.setAttribute('aria-selected', 'false');
      t.setAttribute('tabindex', '-1');
    });
    // Activate all matching tabs (original + clones)
    section.querySelectorAll(`.ingredient-card__tab[data-tab="${tabName}"][data-card="${cardId}"]`).forEach(t => {
      t.classList.add('is-active');
      t.setAttribute('aria-selected', 'true');
      t.setAttribute('tabindex', '0');
    });

    // Update panels for this card (and clones)
    section.querySelectorAll(`.tab-panel[data-card="${cardId}"]`).forEach(p => {
      p.classList.remove('is-active');
    });
    section.querySelectorAll(`.tab-panel[data-panel="${tabName}"][data-card="${cardId}"]`).forEach(p => {
      p.classList.add('is-active');

      // Re-trigger animations
      const animatedItems = p.querySelectorAll('[style*="animation-delay"]');
      animatedItems.forEach(item => {
        item.style.animation = 'none';
        item.offsetHeight;
        item.style.animation = '';
      });
    });
  }

  tabs.forEach(tab => {
    tab.addEventListener('click', function() {
      activateTab(this);
    });

    // Keyboard navigation for tabs (WCAG tab pattern)
    tab.addEventListener('keydown', function(e) {
      const cardId = this.dataset.card;
      const tablist = this.closest('.ingredient-card__tabs');
      const cardTabs = Array.from(tablist.querySelectorAll('.ingredient-card__tab'));
      const currentIndex = cardTabs.indexOf(this);
      let newIndex;

      switch (e.key) {
        case 'ArrowRight':
        case 'ArrowDown':
          e.preventDefault();
          newIndex = (currentIndex + 1) % cardTabs.length;
          cardTabs[newIndex].focus();
          activateTab(cardTabs[newIndex]);
          break;
        case 'ArrowLeft':
        case 'ArrowUp':
          e.preventDefault();
          newIndex = (currentIndex - 1 + cardTabs.length) % cardTabs.length;
          cardTabs[newIndex].focus();
          activateTab(cardTabs[newIndex]);
          break;
        case 'Home':
          e.preventDefault();
          cardTabs[0].focus();
          activateTab(cardTabs[0]);
          break;
        case 'End':
          e.preventDefault();
          cardTabs[cardTabs.length - 1].focus();
          activateTab(cardTabs[cardTabs.length - 1]);
          break;
      }
    });
  });

  // Set initial tabindex state for tabs
  section.querySelectorAll('.ingredient-card__tabs').forEach(tablist => {
    const cardTabs = tablist.querySelectorAll('.ingredient-card__tab');
    cardTabs.forEach(tab => {
      tab.setAttribute('tabindex', tab.classList.contains('is-active') ? '0' : '-1');
    });
  });

  // Mobile Infinite Carousel
  const carousel = section.querySelector('.ingredient-hub__carousel');
  const dots = section.querySelectorAll('.carousel-dot');
  const counterCurrent = section.querySelector('.carousel-counter__current');
  const originalCards = Array.from(section.querySelectorAll('.ingredient-card:not(.is-clone)'));
  const cardCount = originalCards.length;
  const mobileQuery = window.matchMedia('(max-width: 767px)');

  if (carousel && cardCount > 1 && mobileQuery.matches) {
    const gap = 12;
    let cardWidth = 260 + gap; // card width + gap

    // Clone cards for infinite effect
    function setupInfiniteCarousel() {
      // Remove existing clones
      carousel.querySelectorAll('.is-clone').forEach(c => c.remove());

      // Clone all cards and append/prepend for infinite effect
      originalCards.forEach((card, i) => {
        const cloneBefore = card.cloneNode(true);
        const cloneAfter = card.cloneNode(true);
        cloneBefore.classList.add('is-clone');
        cloneAfter.classList.add('is-clone');
        cloneBefore.setAttribute('data-clone-of', i);
        cloneAfter.setAttribute('data-clone-of', i);
        carousel.insertBefore(cloneBefore, carousel.firstChild);
        carousel.appendChild(cloneAfter);
      });

      // Set initial scroll position to first real card
      setTimeout(() => {
        carousel.scrollLeft = cardCount * cardWidth;
      }, 10);
    }

    // Handle infinite scroll looping
    let isJumping = false;
    let scrollTimeout;

    function handleScroll() {
      if (isJumping) return;

      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(() => {
        const scrollLeft = carousel.scrollLeft;
        const totalOriginalWidth = cardCount * cardWidth;

        // Calculate real index (0 to cardCount-1)
        let realIndex = Math.round((scrollLeft - totalOriginalWidth) / cardWidth);
        realIndex = ((realIndex % cardCount) + cardCount) % cardCount;

        // Update dots and counter
        dots.forEach((dot, i) => {
          const isActive = i === realIndex;
          dot.classList.toggle('is-active', isActive);
          dot.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });
        if (counterCurrent) {
          counterCurrent.textContent = realIndex + 1;
        }

        // Jump to real cards if we're in clone territory
        if (scrollLeft <= cardWidth * 0.5) {
          // Scrolled too far left - jump to end
          isJumping = true;
          carousel.style.scrollBehavior = 'auto';
          carousel.scrollLeft = scrollLeft + totalOriginalWidth;
          carousel.style.scrollBehavior = '';
          setTimeout(() => { isJumping = false; }, 50);
        } else if (scrollLeft >= (cardCount * 2 - 0.5) * cardWidth + totalOriginalWidth) {
          // Scrolled too far right - jump to start
          isJumping = true;
          carousel.style.scrollBehavior = 'auto';
          carousel.scrollLeft = scrollLeft - totalOriginalWidth;
          carousel.style.scrollBehavior = '';
          setTimeout(() => { isJumping = false; }, 50);
        }
      }, 100);
    }

    carousel.addEventListener('scroll', handleScroll, { passive: true });

    // Click dot to scroll to card
    dots.forEach((dot, index) => {
      dot.addEventListener('click', function() {
        const targetScroll = (cardCount + index) * cardWidth;
        carousel.scrollTo({
          left: targetScroll,
          behavior: 'smooth'
        });
      });
    });

    // Initialize
    setupInfiniteCarousel();

    // Reinitialize on resize
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        if (mobileQuery.matches) {
          setupInfiniteCarousel();
        }
      }, 250);
    });
  } else if (carousel && dots.length > 0) {
    // Desktop or single card - simple dot navigation
    let scrollTimeout;
    carousel.addEventListener('scroll', function() {
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(() => {
        const cards = section.querySelectorAll('.ingredient-card:not(.is-clone)');
        if (cards.length === 0) return;
        const cardWidth = cards[0].offsetWidth + 16;
        const scrollLeft = carousel.scrollLeft;
        const index = Math.round(scrollLeft / cardWidth);

        dots.forEach((dot, i) => {
          const isActive = i === index;
          dot.classList.toggle('is-active', isActive);
          dot.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });
      }, 50);
    }, { passive: true });

    dots.forEach((dot, index) => {
      dot.addEventListener('click', function() {
        const cards = section.querySelectorAll('.ingredient-card:not(.is-clone)');
        if (cards.length === 0) return;
        const cardWidth = cards[0].offsetWidth + 16;
        carousel.scrollTo({
          left: index * cardWidth,
          behavior: 'smooth'
        });
      });
    });
  }

  // Animate progress bars when Test Results tab is shown
  const testPanels = section.querySelectorAll('.tab-panel[data-panel="tests"]');
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const progressBars = entry.target.querySelectorAll('.test-card__progress-bar');
        progressBars.forEach(bar => {
          bar.style.animation = 'none';
          bar.offsetHeight;
          bar.style.animation = '';
        });
      }
    });
  }, { threshold: 0.5 });

  testPanels.forEach(panel => observer.observe(panel));
})();
</script>

{% schema %}
{
  "name": "Ingredient Science Hub",
  "tag": "section",
  "class": "section-ingredient-hub",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Başlık",
      "default": "İçeriklerimizi Keşfedin"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Alt Başlık",
      "default": "Bilim destekli, şeffaf formül"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Arka Plan Rengi",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Üst Boşluk",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 60
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Alt Boşluk",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 60
    }
  ],
  "blocks": [
    {
      "type": "ingredient",
      "name": "İçerik",
      "settings": [
        {
          "type": "header",
          "content": "Temel Bilgiler"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "İçerik Görseli"
        },
        {
          "type": "text",
          "id": "name",
          "label": "İçerik Adı",
          "default": "Rhodiola Rosea"
        },
        {
          "type": "text",
          "id": "tagline",
          "label": "Slogan",
          "default": "Stres Kalkanı"
        },
        {
          "type": "header",
          "content": "Faydalar Sekmesi"
        },
        {
          "type": "textarea",
          "id": "benefits",
          "label": "Faydalar",
          "info": "Her satıra bir fayda yazın",
          "default": "Bağışıklık sistemini güçlendirir\nEnerji seviyelerini artırır\nStres ve kaygıyı azaltır\nZihinsel odaklanmayı destekler"
        },
        {
          "type": "header",
          "content": "Makaleler Sekmesi"
        },
        {
          "type": "textarea",
          "id": "articles",
          "label": "Bilimsel Makaleler",
          "info": "Format: Başlık|Kaynak|URL (her satıra bir makale)",
          "default": "Rhodiola rosea adaptogenic effects on stress|PubMed|https://pubmed.ncbi.nlm.nih.gov/\nClinical efficacy of Rhodiola|Journal of Ethnopharmacology|https://www.sciencedirect.com/"
        },
        {
          "type": "header",
          "content": "Test Sonuçları Sekmesi"
        },
        {
          "type": "textarea",
          "id": "test_results",
          "label": "Test Sonuçları",
          "info": "Format: Test Adı|Sonuç|Yüzde|Kabul Aralığı (her satıra bir test). Örnek: Ağır Metal Testi|GEÇTİ|100|< 0.1 ppm",
          "default": "Ağır Metal Testi|GEÇTİ|100|< 0.1 ppm\nMikrobiyolojik Test|GEÇTİ|100|< 10 CFU/g\nSaflık Analizi|GEÇTİ|99.2|> 98%\nPestisit Testi|GEÇTİ|100|Tespit Edilmedi"
        },
        {
          "type": "text",
          "id": "certification",
          "label": "Sertifika",
          "default": "ISO 22000"
        },
        {
          "type": "text",
          "id": "test_date",
          "label": "Test Tarihi",
          "default": "Ocak 2024"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Ingredient Science Hub",
      "blocks": [
        {
          "type": "ingredient",
          "settings": {
            "name": "Rhodiola Rosea",
            "tagline": "Stres Kalkanı",
            "benefits": "Bağışıklık sistemini güçlendirir\nEnerji seviyelerini artırır\nStres ve kaygıyı azaltır\nZihinsel odaklanmayı destekler",
            "articles": "Rhodiola rosea adaptogenic effects|PubMed|https://pubmed.ncbi.nlm.nih.gov/\nClinical efficacy study|Journal of Ethnopharmacology|https://www.sciencedirect.com/",
            "test_results": "Ağır Metal Testi|GEÇTİ|100|< 0.1 ppm\nMikrobiyolojik Test|GEÇTİ|100|< 10 CFU/g\nSaflık Analizi|GEÇTİ|99.2|> 98%\nPestisit Testi|GEÇTİ|100|Tespit Edilmedi",
            "certification": "ISO 22000",
            "test_date": "Ocak 2024"
          }
        },
        {
          "type": "ingredient",
          "settings": {
            "name": "Ashwagandha",
            "tagline": "Adaptojenik Güç",
            "benefits": "Kortizol seviyelerini dengeler\nUyku kalitesini artırır\nKas gücünü destekler\nBilişsel fonksiyonları iyileştirir",
            "articles": "Ashwagandha for anxiety and stress|PubMed|https://pubmed.ncbi.nlm.nih.gov/\nWithanolides biological activity|Phytomedicine|https://www.sciencedirect.com/",
            "test_results": "Ağır Metal Testi|GEÇTİ|100|< 0.1 ppm\nMikrobiyolojik Test|GEÇTİ|100|< 10 CFU/g\nSaflık Analizi|GEÇTİ|98.5|> 98%\nPestisit Testi|GEÇTİ|100|Tespit Edilmedi",
            "certification": "GMP Sertifikalı",
            "test_date": "Aralık 2023"
          }
        },
        {
          "type": "ingredient",
          "settings": {
            "name": "Reishi",
            "tagline": "Ölümsüzlük Mantarı",
            "benefits": "Bağışıklık sistemini destekler\nUyku kalitesini artırır\nStres direncini güçlendirir\nAntioksidan koruma sağlar",
            "articles": "Ganoderma lucidum immunomodulatory effects|PubMed|https://pubmed.ncbi.nlm.nih.gov/\nReishi mushroom benefits|Frontiers in Pharmacology|https://www.frontiersin.org/",
            "test_results": "Ağır Metal Testi|GEÇTİ|100|< 0.1 ppm\nMikrobiyolojik Test|GEÇTİ|100|< 10 CFU/g\nSaflık Analizi|GEÇTİ|97.8|> 98%\nPestisit Testi|GEÇTİ|100|Tespit Edilmedi",
            "certification": "Organik Sertifikalı",
            "test_date": "Kasım 2023"
          }
        }
      ]
    }
  ]
}
{% endschema %}
